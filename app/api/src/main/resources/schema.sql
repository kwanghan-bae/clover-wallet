DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS lotto_ticket CASCADE;
DROP TABLE IF EXISTS lotto_game CASCADE;
DROP TABLE IF EXISTS post CASCADE;
DROP TABLE IF EXISTS post_like CASCADE;
DROP TABLE IF EXISTS comment CASCADE;
DROP TABLE IF EXISTS lotto_spot CASCADE;
DROP TABLE IF EXISTS lotto_winning_store CASCADE;
DROP TABLE IF EXISTS winning_info CASCADE;
DROP TABLE IF EXISTS notification CASCADE;
DROP TABLE IF EXISTS refresh_token CASCADE;
DROP TABLE IF EXISTS token_blacklist CASCADE;
DROP TABLE IF EXISTS travel_plan CASCADE;

CREATE TABLE IF NOT EXISTS users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    sso_qualifier VARCHAR(255) NOT NULL UNIQUE,
    locale VARCHAR(10) NOT NULL DEFAULT 'ko',
    age INT NOT NULL DEFAULT 0,
    fcm_token VARCHAR(500),
    badges VARCHAR(1000),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_users_sso_qualifier ON users(sso_qualifier);

CREATE TABLE IF NOT EXISTS lotto_ticket (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    ordinal INT NOT NULL,
    url TEXT NOT NULL UNIQUE,
    status VARCHAR(50) NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_lotto_ticket_user_id ON lotto_ticket(user_id);
CREATE INDEX IF NOT EXISTS idx_lotto_ticket_url ON lotto_ticket(url);
CREATE INDEX IF NOT EXISTS idx_lotto_ticket_status ON lotto_ticket(status);

CREATE TABLE IF NOT EXISTS lotto_game (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ticket_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    status VARCHAR(50) NOT NULL,
    number1 INT NOT NULL,
    number2 INT NOT NULL,
    number3 INT NOT NULL,
    number4 INT NOT NULL,
    number5 INT NOT NULL,
    number6 INT NOT NULL,
    extraction_method VARCHAR(50),
    prize_amount BIGINT DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_lotto_game_ticket_id ON lotto_game(ticket_id);
CREATE INDEX IF NOT EXISTS idx_lotto_game_user_id ON lotto_game(user_id);

CREATE TABLE IF NOT EXISTS post (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    likes INT DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_post_user_id ON post(user_id);
CREATE INDEX IF NOT EXISTS idx_post_created_at ON post(created_at DESC);

CREATE TABLE IF NOT EXISTS comment (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    post_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    likes INT DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_comment_post_id ON comment(post_id);
CREATE INDEX IF NOT EXISTS idx_comment_user_id ON comment(user_id);

CREATE TABLE IF NOT EXISTS lotto_spot (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    address VARCHAR(500) NOT NULL,
    latitude DOUBLE PRECISION NOT NULL,
    longitude DOUBLE PRECISION NOT NULL,
    first_place_wins INT DEFAULT 0,
    second_place_wins INT DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_lotto_spot_name ON lotto_spot(name);

CREATE TABLE IF NOT EXISTS lotto_winning_store (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    round INT NOT NULL,
    rank INT NOT NULL,
    store_name VARCHAR(255) NOT NULL,
    address VARCHAR(500) NOT NULL,
    method VARCHAR(50),
    created_at TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_lotto_winning_store_round ON lotto_winning_store(round);

CREATE TABLE IF NOT EXISTS winning_info (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    round INT NOT NULL UNIQUE,
    draw_date DATE NOT NULL,
    number1 INT NOT NULL,
    number2 INT NOT NULL,
    number3 INT NOT NULL,
    number4 INT NOT NULL,
    number5 INT NOT NULL,
    number6 INT NOT NULL,
    bonus_number INT NOT NULL,
    first_prize_amount BIGINT NOT NULL,
    second_prize_amount BIGINT NOT NULL,
    third_prize_amount BIGINT NOT NULL,
    fourth_prize_amount BIGINT NOT NULL,
    fifth_prize_amount BIGINT NOT NULL
);

CREATE TABLE IF NOT EXISTS post_like (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    post_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(post_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_post_like_post_id ON post_like(post_id);
CREATE INDEX IF NOT EXISTS idx_post_like_user_id ON post_like(user_id);

CREATE TABLE IF NOT EXISTS notification (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    type VARCHAR(50) DEFAULT 'INFO',
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_notification_user_id ON notification(user_id);
CREATE INDEX IF NOT EXISTS idx_notification_is_read ON notification(is_read);

CREATE TABLE IF NOT EXISTS refresh_token (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    token VARCHAR(500) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_refresh_token_user_id ON refresh_token(user_id);
CREATE INDEX IF NOT EXISTS idx_refresh_token_token ON refresh_token(token);

CREATE TABLE IF NOT EXISTS token_blacklist (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    token VARCHAR(500) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_token_blacklist_token ON token_blacklist(token);
CREATE INDEX IF NOT EXISTS idx_token_blacklist_expires_at ON token_blacklist(expires_at);

CREATE TABLE IF NOT EXISTS travel_plan (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    spot_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    places TEXT NOT NULL,
    theme VARCHAR(50) NOT NULL,
    estimated_hours INT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_travel_plan_spot_id ON travel_plan(spot_id);
CREATE INDEX IF NOT EXISTS idx_travel_plan_theme ON travel_plan(theme);

-- ==========================================
-- 더미 데이터 (테스트용)
-- ==========================================

-- 사용자 더미 데이터
INSERT INTO users (id, sso_qualifier, locale, age, badges, created_at, updated_at) VALUES
(1, 'test-user-001', 'ko_KR', 30, 'FIRST_WIN,DREAM_MASTER,FREQUENT_PLAYER', NOW(), NOW()),
(2, 'test-user-002', 'ko_KR', 25, 'LUCKY_1ST,STATS_GENIUS', NOW(), NOW()),
(3, 'test-user-003', 'ko_KR', 35, 'SAJU_EXPERT,VETERAN', NOW(), NOW())
ON CONFLICT (id) DO NOTHING;

-- 로또 티켓 더미 데이터
INSERT INTO lotto_ticket (id, user_id, ordinal, url, status, created_at, updated_at) VALUES
(1, 1, 1150, 'https://dhlottery.co.kr/test1', 'WINNING', NOW() - INTERVAL '2 days', NOW() - INTERVAL '2 days'),
(2, 1, 1151, 'https://dhlottery.co.kr/test2', 'STASHED', NOW() - INTERVAL '1 day', NOW() - INTERVAL '1 day'),
(3, 2, 1150, 'https://dhlottery.co.kr/test3', 'WINNING', NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days'),
(4, 3, 1149, 'https://dhlottery.co.kr/test4', 'LOSING', NOW() - INTERVAL '7 days', NOW() - INTERVAL '7 days')
ON CONFLICT (id) DO NOTHING;

-- 로또 게임 더미 데이터 (다양한 추출 방식 포함)
INSERT INTO lotto_game (id, ticket_id, user_id, status, number1, number2, number3, number4, number5, number6, extraction_method, created_at, updated_at) VALUES
-- 당첨 게임 (마케팅용)
(1, 1, 1, 'WINNING_3', 7, 11, 23, 34, 38, 42, 'DREAM', NOW() - INTERVAL '2 days', NOW() - INTERVAL '2 days'),
(2, 1, 1, 'WINNING_5', 3, 15, 22, 29, 31, 45, 'SAJU', NOW() - INTERVAL '2 days', NOW() - INTERVAL '2 days'),
(3, 3, 2, 'WINNING_1', 5, 12, 18, 27, 33, 41, 'STATISTICS_HOT', NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days'),
(4, 3, 2, 'WINNING_2', 9, 14, 20, 25, 36, 43, 'HOROSCOPE', NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days'),
-- 대기 게임
(5, 2, 1, 'LOSING', 1, 10, 19, 28, 37, 44, 'NATURE_PATTERNS', NOW() - INTERVAL '1 day', NOW() - INTERVAL '1 day'),
(6, 2, 1, 'LOSING', 2, 8, 16, 24, 32, 40, 'ANCIENT_DIVINATION', NOW() - INTERVAL '1 day', NOW() - INTERVAL '1 day'),
-- 낙첨 게임
(7, 4, 3, 'LOSING', 4, 13, 21, 30, 39, 41, 'COLORS_SOUNDS', NOW() - INTERVAL '7 days', NOW() - INTERVAL '7 days'),
(8, 4, 3, 'LOSING', 6, 11, 17, 26, 35, 44, 'ANIMAL_OMENS', NOW() - INTERVAL '7 days', NOW() - INTERVAL '7 days')
ON CONFLICT (id) DO NOTHING;

-- 커뮤니티 게시글 더미 데이터
INSERT INTO post (id, user_id, title, content, likes, created_at, updated_at) VALUES
(1, 1, '드디어 3등 당첨!', '꿈 해몽 방식으로 선택한 번호로 당첨됐어요! 진짜 신기합니다 ㅎㅎ', 24, NOW() - INTERVAL '2 days', NOW() - INTERVAL '2 days'),
(2, 2, '1등 당첨 후기', '통계 분석으로 뽑은 번호로 드디어... 아직도 실감이 안 나네요', 156, NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days'),
(3, 3, '사주팔자 방식 추천합니다', '여러 방식 써봤는데 사주팔자가 제일 재미있어요', 12, NOW() - INTERVAL '5 days', NOW() - INTERVAL '5 days'),
(4, 1, '이번 주 로또 구매 완료', '이번엔 별자리 운세로 도전해봅니다!', 8, NOW() - INTERVAL '1 day', NOW() - INTERVAL '1 day')
ON CONFLICT (id) DO NOTHING;

-- 댓글 더미 데이터
INSERT INTO comment (id, post_id, user_id, content, likes, created_at, updated_at) VALUES
(1, 1, 2, '축하드려요! 저도 곧 당첨될 것 같은 예감이...', 3, NOW() - INTERVAL '2 days', NOW() - INTERVAL '2 days'),
(2, 1, 3, '꿈 해몽 정말 신기하네요 ㄷㄷ', 2, NOW() - INTERVAL '2 days', NOW() - INTERVAL '2 days'),
(3, 2, 1, '와... 대박이십니다!!! 축하드려요!', 15, NOW() - INTERVAL '3 days', NOW() - INTERVAL '3 days'),
(4, 3, 2, '저도 사주팔자 써봐야겠어요', 1, NOW() - INTERVAL '5 days', NOW() - INTERVAL '5 days')
ON CONFLICT (id) DO NOTHING;

-- 로또 명당 더미 데이터
INSERT INTO lotto_spot (id, name, address, latitude, longitude, created_at, updated_at) VALUES
(1, '행운복권방', '서울특별시 강남구 테헤란로 231', 37.5013, 127.0396, NOW(), NOW()),
(2, '대박로또', '서울특별시 중구 명동길 74', 37.5636, 126.9860, NOW(), NOW()),
(3, '황금복권', '서울특별시 송파구 올림픽로 300', 37.5145, 127.1060, NOW(), NOW()),
(4, '당첨로또방', '서울특별시 마포구 양화로 188', 37.5547, 126.9228, NOW(), NOW())
ON CONFLICT (id) DO NOTHING;

-- 여행 플랜 샘플 데이터
INSERT INTO travel_plan (id, spot_id, title, description, places, theme, estimated_hours, created_at) VALUES
(1, 1, '강남 명당 + 문화탐방 코스', '강남역 로또명당 방문 후 코엑스와 봉은사를 둘러보는 반나절 코스', '[{"name":"강남역 로또명당","type":"lotto_spot","lat":37.498,"lng":127.027},{"name":"코엑스 별마당 도서관","type":"tourism","lat":37.512,"lng":127.059},{"name":"봉은사","type":"tourism","lat":37.514,"lng":127.053},{"name":"삼원가든","type":"restaurant","lat":37.518,"lng":127.038}]', '문화', 4, NOW()),
(2, 2, '명동 명당 + 맛집 투어', '명동 대박로또 방문 후 근처 맛집 탐방', '[{"name":"명동 대박로또","type":"lotto_spot","lat":37.5636,"lng":126.9860},{"name":"명동교자","type":"restaurant","lat":37.5640,"lng":126.9850},{"name":"N서울타워","type":"tourism","lat":37.5512,"lng":126.9882}]', '맛집', 3, NOW()),
(3, 3, '송파 명당 + 자연 힐링', '올림픽공원 주변 명당과 자연 코스', '[{"name":"송파 황금복권","type":"lotto_spot","lat":37.5145,"lng":127.1060},{"name":"올림픽공원","type":"tourism","lat":37.5219,"lng":127.1211},{"name":"롯데월드타워","type":"tourism","lat":37.5125,"lng":127.1025}]', '자연', 5, NOW()),
(4, 4, '마포 명당 + 한강 뷰', '마포 당첨로또방과 함께하는 한강 산책 코스', '[{"name":"마포 당첨로또방","type":"lotto_spot","lat":37.5547,"lng":126.9228},{"name":"망원한강공원","type":"tourism","lat":37.5556,"lng":126.8970},{"name":"경의선숲길","type":"tourism","lat":37.5550,"lng":126.9240}]', '자연', 3, NOW()),
(5, 1, '강남 명당 + 쇼핑', '강남 명당 방문 후 현대백화점과 가로수길 쇼핑', '[{"name":"강남역 로또명당","type":"lotto_spot","lat":37.498,"lng":127.027},{"name":"현대백화점 무역점","type":"tourism","lat":37.510,"lng":127.060},{"name":"가로수길","type":"tourism","lat":37.520,"lng":127.023}]', '문화', 4, NOW()),
(6, 2, '명동 명당 + 역사탐방', '명동 로또명당과 역사 유적지 탐방', '[{"name":"명동 대박로또","type":"lotto_spot","lat":37.5636,"lng":126.9860},{"name":"덕수궁","type":"tourism","lat":37.5658,"lng":126.9751},{"name":"정동길","type":"tourism","lat":37.5665,"lng":126.9723}]', '문화', 4, NOW())
ON CONFLICT (id) DO NOTHING;

-- ID 시퀀스 조정
SELECT setval('users_id_seq', (SELECT COALESCE(MAX(id), 1) FROM users));
SELECT setval('lotto_ticket_id_seq', (SELECT COALESCE(MAX(id), 1) FROM lotto_ticket));
SELECT setval('lotto_game_id_seq', (SELECT COALESCE(MAX(id), 1) FROM lotto_game));
SELECT setval('post_id_seq', (SELECT COALESCE(MAX(id), 1) FROM post));
SELECT setval('comment_id_seq', (SELECT COALESCE(MAX(id), 1) FROM comment));
SELECT setval('lotto_spot_id_seq', (SELECT COALESCE(MAX(id), 1) FROM lotto_spot));
SELECT setval('travel_plan_id_seq', (SELECT COALESCE(MAX(id), 1) FROM travel_plan));
